<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batangas Explorer - MTO Reports Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #003366;
            --accent: #ff7e00;
            --light-bg: #f8f9fa;
            --memo-color: #0d6efd;
            --destinations-color: #198754;
            --updates-color: #0dcaf0;
            --about-color: #6c757d;
            --local-color: #28a745;
            --foreign-color: #6f42c1;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
        }
        .top-header {
            background-color: var(--primary);
            padding: 0.8rem;
            color: white;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo-text {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
            display: flex;
            align-items: center;
        }
        .logo-text:hover {
            color: white;
        }
        .user-profile {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: var(--primary);
        }
        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            position: relative;
            padding-bottom: 0.5rem;
            color: var(--primary);
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 4px;
            background-color: var(--accent);
            border-radius: 2px;
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s;
            height: 100%;
            margin-bottom: 20px;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .sidebar {
            background-color: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.05);
            height: calc(100vh - 70px);
            position: sticky;
            top: 70px;
        }
        .sidebar-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: #666;
            text-decoration: none;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        .sidebar-link:hover, .sidebar-link.active {
            background-color: rgba(0, 51, 102, 0.05);
            color: var(--primary);
            border-left-color: var(--accent);
        }
        .sidebar-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--accent);
            color: white;
            font-size: 0.7rem;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .tab-btn {
            background-color: var(--light-bg);
            border: none;
            padding: 10px 20px;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background-color: #fff;
            color: var(--primary);
            border-bottom: 3px solid var(--accent);
        }
        .table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
            border: none;
        }
        .status-active {
            background-color: #d1e7dd;
            color: #0f5132;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-pending {
            background-color: #fff3cd;
            color: #664d03;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .status-expired {
            background-color: #f8d7da;
            color: #842029;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .table-responsive {
            overflow-x: auto;
        }
        .table td, .table th {
            vertical-align: middle;
            padding: 0.5rem;
        }
        .report-filter {
            background: var(--light-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        .filter-group {
            margin-right: 2rem;
        }
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        @media (max-width: 992px) {
            .sidebar {
                height: auto;
                position: relative;
                top: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="top-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <a href="#" class="logo-text text-decoration-none text-white">
                    <img src="{{ url_for('serve_static_file', filename='img/Batangas_Logo.png') }}" alt="Logo" class="me-2" width="60" height="55">
                    Batangas Explorer - MTO Panel
                </a>
                <div class="d-flex align-items-center">
                    <div class="dropdown">
                        <button class="btn btn-outline-light dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-2"></i>
                            MTO User
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
                            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/login"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>



    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-2 px-0">
                <!-- Sidebar -->
                <div class="sidebar">
                    <a href="/mto/dashboard" class="sidebar-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/mto/destinations" class="sidebar-link">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>Destinations</span>
                    </a>
                    <a href="/property/mto/property" class="sidebar-link">
                        <i class="fas fa-hotel"></i>
                        <span>Properties</span>
                    </a>
                    <a href="/mto/visitors" class="sidebar-link">
                        <i class="fas fa-users"></i>
                        <span>Visitors</span>
                    </a>
                    <a href="/mto/analytics" class="sidebar-link">
                        <i class="fas fa-chart-line"></i>
                        <span>Analytics</span>
                    </a>
                    <a href="/mto/events" class="sidebar-link">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Events</span>
                    </a>
                    <a href="/mto/announcements" class="sidebar-link active">
                        <i class="fas fa-bullhorn"></i>
                        <span> Announcements</span>
                    </a>
                    <a href="/mto/reports" class="sidebar-link active">
                        <i class="fas fa-file-alt"></i>
                        <span>Reports</span>
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 py-4">
                <div class="mb-4 d-flex justify-content-between align-items-center">
                    <h1 class="section-title mb-0">MTO Reports</h1>
                    <div>
                        <button class="btn btn-outline-primary me-2" id="exportBtn">
                            <i class="fas fa-download me-1"></i> Export Reports
                        </button>
                        <button class="btn btn-primary me-2" id="uploadBtn">
                            <i class="fas fa-upload me-1"></i> Upload Report
                        </button>
                        <button class="btn btn-success" id="addReportBtn">
                            <i class="fas fa-plus me-1"></i> Add Report
                        </button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="mb-4">
                    <button class="tab-btn active" data-tab="property-report">Resort & Property Report</button>
                    <button class="tab-btn" data-tab="tourist-report">Tourist Report</button>
                </div>

                <!-- Resort & Property Report Tab -->
                <div id="property-report" class="tab-content active">
                    <div class="report-filter d-flex">
                        <div class="filter-group">
                            <label>Date Range:</label>
                            <select class="form-select form-select-sm" id="dateRangeFilter">
                                <option value="all">All</option>
                                <option value="last_week">Last Week</option>
                                <option value="last_month">Last Month</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Barangay:</label>
                            <select class="form-select form-select-sm" id="barangayFilter">
                                <option value="all">All</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Property Type:</label>
                            <select class="form-select form-select-sm" id="typeFilter">
                                <option value="all">All</option>
                                <option value="Hotel">HTL(Hotel)</option>
                                <option value="Resort">RES (Resort)</option>
                                <option value="Villa">CON (Condotel)</option>
                                <option value="Pension">SER (Service Residence)</option>
                                <option value="Pension">APA (Apartelle)</option>
                                <option value="Pension">MOT (Motel)</option>
                                <option value="Pension">PEN (Pension)</option>
                                <option value="Pension">HSS (Home Stay Site)</option>
                                <option value="Pension">TIN (Tourist Inn)</option>
                                <option value="Pension">MH (Motorist Hotel)</option>
                            </select>
                        </div>
                        <button class="btn btn-sm btn-primary align-self-end" id="applyFilters">
                            <i class="fas fa-filter me-1"></i> Apply
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>AE-ID</th>
                                            <th>AE Name</th>
                                            <th>Barangay</th>
                                            <th>Type-Class</th>
                                            <th>DOT-Accredited</th>
                                            <th>DOT Valid Until</th>
                                            <th>PTCAO-Registered</th>
                                            <th>PTCAO Valid Until</th>
                                            <th>Classification</th>
                                            <th>Male Employees</th>
                                            <th>Female Employees</th>
                                            <th>Total No. of Employees</th>
                                            <th>Daytour 100% Capacity</th>
                                            <th>Overnight 100% Capacity</th>
                                            <th>Total No. of Rooms</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="reportTableBody">
                                        <!-- Data will be loaded dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between mt-3">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">Rows per page:</span>
                                    <select class="form-select form-select-sm" id="rowsPerPage" style="width: 70px;">
                                        <option>10</option>
                                        <option>25</option>
                                        <option>50</option>
                                        <option>100</option>
                                    </select>
                                </div>
                                <div>
                                    <span id="pageInfo" class="me-3">Page 1 of 1</span>
                                    <button class="btn btn-sm btn-outline-secondary me-1" id="prevPage">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="nextPage">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tourist Report Tab -->
                <div id="tourist-report" class="tab-content">
                    <div class="report-filter d-flex">
                        <div class="filter-group">
                            <label>Date Range:</label>
                            <select class="form-select form-select-sm" id="propDateRangeFilter">
                                <option value="all">All</option>
                                <option value="last_week">Last Week</option>
                                <option value="last_month">Last Month</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Property Type:</label>
                            <select class="form-select form-select-sm" id="propTypeFilter">
                                <option value="all">All</option>
                                <option value="Hotel">HTL(Hotel)</option>
                                <option value="Resort">RES (Resort)</option>
                                <option value="Villa">CON (Condotel)</option>
                                <option value="Pension">SER (Service Residence)</option>
                                <option value="Pension">APA (Apartelle)</option>
                                <option value="Pension">MOT (Motel)</option>
                                <option value="Pension">PEN (Pension)</option>
                                <option value="Pension">HSS (Home Stay Site)</option>
                                <option value="Pension">TIN (Tourist Inn)</option>
                                <option value="Pension">MH (Motorist Hotel)</option>
                            </select>
                        </div>
                        <button class="btn btn-sm btn-primary align-self-end" id="applyPropFilters">
                            <i class="fas fa-filter me-1"></i> Apply
                        </button>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>AE-ID</th>
                                            <th>AE Name</th>
                                            <th>Barangay</th>
                                            <th>Type-Class</th>
                                            <th>Total Guest Check In Day Tour</th>
                                            <th>Total Guest Check In Overnight</th>
                                            <th>Total No. of Guest Check In</th>
                                            <th>Total No. of Rooms Occupied</th>
                                            <th>Total Foreign Visitor Arrival Day Tour</th>
                                            <th>Total Guest Over night Foreign Visitor</th>
                                            <th>Total No. of Male Tourists</th>
                                            <th>Total No. of Female Tourists</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="propReportTableBody">
                                        <!-- Data will be loaded dynamically -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between mt-3">
                                <div class="d-flex align-items-center">
                                    <span class="me-2">Rows per page:</span>
                                    <select class="form-select form-select-sm" id="propRowsPerPage" style="width: 70px;">
                                        <option>10</option>
                                        <option>25</option>
                                        <option>50</option>
                                        <option>100</option>
                                    </select>
                                </div>
                                <div>
                                    <span id="propPageInfo" class="me-3">Page 1 of 1</span>
                                    <button class="btn btn-sm btn-outline-secondary me-1" id="propPrevPage">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary" id="propNextPage">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container">
        <div class="toast align-items-center text-white bg-success" role="alert" aria-live="assertive" aria-atomic="true" id="successToast">
            <div class="d-flex">
                <div class="toast-body"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
        <div class="toast align-items-center text-white bg-danger" role="alert" aria-live="assertive" aria-atomic="true" id="errorToast">
            <div class="d-flex">
                <div class="toast-body"></div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="reportFile" class="form-label">Select Excel/CSV File</label>
                            <input class="form-control" type="file" id="reportFile" name="file" accept=".xlsx,.xls,.csv" required>
                        </div>
                        <div class="mb-3">
                            <label for="reportType" class="form-label">Report Type</label>
                            <select class="form-select" id="reportType" name="report_type" required>
                                <option value="">Select report type</option>
                                <option value="property">Resort & Property Report</option>
                                <option value="tourist">Tourist Report</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitUpload">Upload</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Property Report Modal -->
    <div class="modal fade" id="addPropertyReportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Property Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="propertyReportForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Property</label>
                                    <select class="form-select" id="propertySelect" required>
                                        <option value="">Loading properties...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">DOT Accredited</label>
                                    <select class="form-select" id="dotAccredited">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">DOT Valid Until</label>
                                    <input type="date" class="form-control" id="dotValidUntil">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">PTCAO Registered</label>
                                    <select class="form-select" id="ptcaoRegistered">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">PTCAO Valid Until</label>
                                    <input type="date" class="form-control" id="ptcaoValidUntil">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Classification</label>
                                    <select class="form-select" id="classification">
                                        <option value="Luxury">Luxury</option>
                                        <option value="Standard">Standard</option>
                                        <option value="Economy">Economy</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Male Employees</label>
                                    <input type="number" class="form-control" id="maleEmployees" value="0" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Female Employees</label>
                                    <input type="number" class="form-control" id="femaleEmployees" value="0" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Total Rooms</label>
                                    <input type="number" class="form-control" id="totalRooms" value="0" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Daytour Capacity</label>
                                    <input type="number" class="form-control" id="daytourCapacity" value="0" min="0">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Overnight Capacity</label>
                                    <input type="number" class="form-control" id="overnightCapacity" value="0" min="0">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitPropertyReport">Submit Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Tourist Report Modal -->
    <div class="modal fade" id="addTouristReportModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Tourist Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="touristReportForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Property</label>
                                    <select class="form-select" id="touristPropertySelect" required>
                                        <option value="">Loading properties...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Report Date</label>
                                    <input type="date" class="form-control" id="reportDate" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Day Tour Guests</label>
                                    <input type="number" class="form-control" id="dayTourGuests" value="0" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Overnight Guests</label>
                                    <input type="number" class="form-control" id="overnightGuests" value="0" min="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Rooms Occupied</label>
                                    <input type="number" class="form-control" id="roomsOccupied" value="0" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Foreign Daytour Visitors</label>
                                    <input type="number" class="form-control" id="foreignDaytour" value="0" min="0">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Foreign Overnight Visitors</label>
                                    <input type="number" class="form-control" id="foreignOvernight" value="0" min="0">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Male Tourists</label>
                                    <input type="number" class="form-control" id="maleTourists" value="0" min="0">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Female Tourists</label>
                                    <input type="number" class="form-control" id="femaleTourists" value="0" min="0">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitTouristReport">Submit Report</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Bootstrap components
            const toastElList = [].slice.call(document.querySelectorAll('.toast'));
            const toastList = toastElList.map(function(toastEl) {
                return new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
            });
            const uploadModal = new bootstrap.Modal(document.getElementById('uploadModal'));
            const propertyReportModal = new bootstrap.Modal(document.getElementById('addPropertyReportModal'));
            const touristReportModal = new bootstrap.Modal(document.getElementById('addTouristReportModal'));

            // Current state
            let currentPage = 1;
            let currentPropPage = 1;
            let rowsPerPage = 10;
            let propRowsPerPage = 10;
            let totalPages = 1;
            let propTotalPages = 1;
            let currentFilters = {
                date_range: 'all',
                barangay: 'all',
                type: 'all'
            };
            let currentPropFilters = {
                date_range: 'all',
                type: 'all'
            };

            // DOM Elements
            const reportTableBody = document.getElementById('reportTableBody');
            const propReportTableBody = document.getElementById('propReportTableBody');
            const pageInfo = document.getElementById('pageInfo');
            const propPageInfo = document.getElementById('propPageInfo');
            const exportBtn = document.getElementById('exportBtn');
            const uploadBtn = document.getElementById('uploadBtn');
            const addReportBtn = document.getElementById('addReportBtn');
            const submitUpload = document.getElementById('submitUpload');
            const submitPropertyReport = document.getElementById('submitPropertyReport');
            const submitTouristReport = document.getElementById('submitTouristReport');
            const uploadForm = document.getElementById('uploadForm');

            // Initialize the page
            initPage();

            function initPage() {
                loadBarangays();
                loadPropertyReport();
                loadTouristReport();
                loadPropertiesForModal();
                setupEventListeners();

                // Set default date to today for tourist report
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            }

            function loadPropertiesForModal() {
                fetch('/property/mto/properties', {
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch properties');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Update property select for tourist report
                        const touristSelect = document.getElementById('touristPropertySelect');
                        touristSelect.innerHTML = '<option value="">Select Property</option>';

                        data.data.forEach(property => {
                            const option = document.createElement('option');
                            option.value = property.id;
                            option.textContent = `${property.name} (${property.barangay})`;
                            touristSelect.appendChild(option);
                        });

                        // Also update property select for property report if needed
                        const propertySelect = document.getElementById('propertySelect');
                        if (propertySelect) {
                            propertySelect.innerHTML = '<option value="">Select Property</option>';
                            data.data.forEach(property => {
                                const option = document.createElement('option');
                                option.value = property.id;
                                option.textContent = `${property.name} (${property.barangay})`;
                                propertySelect.appendChild(option);
                            });
                        }
                    } else {
                        showError(data.message || 'Failed to load properties');
                    }
                })
                .catch(error => {
                    console.error('Error loading properties:', error);
                    showError('Error loading properties: ' + error.message);
                });
            }

            // Call this when the modal is shown
            document.getElementById('addTouristReportModal').addEventListener('shown.bs.modal', function() {
                loadPropertiesForModal();
                document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            });

            document.getElementById('addPropertyReportModal').addEventListener('shown.bs.modal', function() {
                loadPropertiesForModal();
            });

            function loadBarangays() {
                fetch('/api/visitors/barangays')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const select = document.getElementById('barangayFilter');
                            data.data.forEach(barangay => {
                                const option = document.createElement('option');
                                option.value = barangay;
                                option.textContent = barangay;
                                select.appendChild(option);
                            });
                        }
                    });
            }

            function loadPropertyReport(page = 1) {
                const params = new URLSearchParams({
                    ...currentFilters,
                    page: page,
                    per_page: rowsPerPage
                });

                fetch(`/mto/api/reports/properties?${params.toString()}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            renderPropertyReport(data.data);
                            updatePagination(data, 'property');
                        } else {
                            showError(data.message || 'Failed to load property report');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading property report:', error);
                        showError('Error loading property report: ' + error.message);
                    });
            }

            function loadTouristReport(page = 1) {
                const params = new URLSearchParams({
                    ...currentPropFilters,
                    page: page,
                    per_page: propRowsPerPage
                });

                fetch(`/mto/api/reports/property-data?${params.toString()}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            renderTouristReport(data.data);
                            updatePagination(data, 'tourist');
                        } else {
                            showError(data.message || 'Failed to load tourist report');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading tourist report:', error);
                        showError('Error loading tourist report: ' + error.message);
                    });
            }

            function renderPropertyReport(data) {
                reportTableBody.innerHTML = '';

                if (data.length === 0) {
                    reportTableBody.innerHTML = `
                        <tr>
                            <td colspan="16" class="text-center py-4">No property report data found</td>
                        </tr>
                    `;
                    return;
                }

                data.forEach(property => {
                    const row = document.createElement('tr');
                    row.dataset.id = property.property_id;

                    row.innerHTML = `
                        <td>${property.property_id}</td>
                        <td>${property.name}</td>
                        <td>${property.barangay}</td>
                        <td>${property.type}</td>
                        <td>${property.dot_accredited ? 'Yes' : 'No'}</td>
                        <td>${property.dot_valid || '-'}</td>
                        <td>${property.ptcao_registered ? 'Yes' : 'No'}</td>
                        <td>${property.ptcao_valid || '-'}</td>
                        <td>${property.classification || '-'}</td>
                        <td>${property.male_employees}</td>
                        <td>${property.female_employees}</td>
                        <td>${property.male_employees + property.female_employees}</td>
                        <td>${property.daytour_capacity}</td>
                        <td>${property.overnight_capacity}</td>
                        <td>${property.total_rooms}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-btn">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    reportTableBody.appendChild(row);
                });

                // Add event listeners for edit buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const propertyId = this.closest('tr').dataset.id;
                        editPropertyReport(propertyId);
                    });
                });
            }

            function renderTouristReport(data) {
                propReportTableBody.innerHTML = '';

                if (data.length === 0) {
                    propReportTableBody.innerHTML = `
                        <tr>
                            <td colspan="13" class="text-center py-4">No tourist report data found</td>
                        </tr>
                    `;
                    return;
                }

                data.forEach(report => {
                    const row = document.createElement('tr');
                    row.dataset.id = report.property_id;

                    row.innerHTML = `
                        <td>${report.property_id}</td>
                        <td>${report.name}</td>
                        <td>${report.barangay}</td>
                        <td>${report.type}</td>
                        <td>${report.day_tour_guests}</td>
                        <td>${report.overnight_guests}</td>
                        <td>${report.day_tour_guests + report.overnight_guests}</td>
                        <td>${report.rooms_occupied}</td>
                        <td>${report.foreign_daytour}</td>
                        <td>${report.foreign_overnight}</td>
                        <td>${report.male_tourists}</td>
                        <td>${report.female_tourists}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-btn">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    propReportTableBody.appendChild(row);
                });

                // Add event listeners for edit buttons
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const propertyId = this.closest('tr').dataset.id;
                        editTouristReport(propertyId);
                    });
                });
            }

            function updatePagination(data, type) {
                if (type === 'property') {
                    totalPages = data.pages;
                    pageInfo.textContent = `Page ${data.current_page} of ${totalPages}`;

                    document.getElementById('prevPage').disabled = data.current_page === 1;
                    document.getElementById('nextPage').disabled = data.current_page === totalPages;
                } else {
                    propTotalPages = data.pages;
                    propPageInfo.textContent = `Page ${data.current_page} of ${propTotalPages}`;

                    document.getElementById('propPrevPage').disabled = data.current_page === 1;
                    document.getElementById('propNextPage').disabled = data.current_page === propTotalPages;
                }
            }

            function editPropertyReport(propertyId) {
                fetch(`/api/reports/properties?property_id=${propertyId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data.length > 0) {
                            const property = data.data[0];

                            document.getElementById('propertySelect').value = property.property_id;
                            document.getElementById('dotAccredited').value = property.dot_accredited ? 'true' : 'false';
                            document.getElementById('dotValidUntil').value = property.dot_valid || '';
                            document.getElementById('ptcaoRegistered').value = property.ptcao_registered ? 'true' : 'false';
                            document.getElementById('ptcaoValidUntil').value = property.ptcao_valid || '';
                            document.getElementById('classification').value = property.classification || 'Standard';
                            document.getElementById('maleEmployees').value = property.male_employees;
                            document.getElementById('femaleEmployees').value = property.female_employees;
                            document.getElementById('totalRooms').value = property.total_rooms;
                            document.getElementById('daytourCapacity').value = property.daytour_capacity;
                            document.getElementById('overnightCapacity').value = property.overnight_capacity;

                            propertyReportModal.show();
                        }
                    })
                    .catch(error => showError('Error loading property data: ' + error));
            }

            function editTouristReport(propertyId) {
                fetch(`/mto/api/reports/property-data?property_id=${propertyId}&per_page=1`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data.length > 0) {
                            const report = data.data[0];

                            document.getElementById('touristPropertySelect').value = report.property_id;
                            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                            document.getElementById('dayTourGuests').value = report.day_tour_guests;
                            document.getElementById('overnightGuests').value = report.overnight_guests;
                            document.getElementById('roomsOccupied').value = report.rooms_occupied;
                            document.getElementById('foreignDaytour').value = report.foreign_daytour;
                            document.getElementById('foreignOvernight').value = report.foreign_overnight;
                            document.getElementById('maleTourists').value = report.male_tourists;
                            document.getElementById('femaleTourists').value = report.female_tourists;

                            touristReportModal.show();
                        }
                    })
                    .catch(error => showError('Error loading tourist data: ' + error));
            }

            function setupEventListeners() {
                // Tab switching
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.tab-btn, .tab-content').forEach(el => {
                            el.classList.remove('active');
                        });
                        btn.classList.add('active');
                        document.getElementById(btn.dataset.tab).classList.add('active');
                    });
                });

                // Filter application
                document.getElementById('applyFilters').addEventListener('click', () => {
                    currentFilters = {
                        date_range: document.getElementById('dateRangeFilter').value,
                        barangay: document.getElementById('barangayFilter').value,
                        type: document.getElementById('typeFilter').value
                    };
                    currentPage = 1;
                    loadPropertyReport();
                });

                document.getElementById('applyPropFilters').addEventListener('click', () => {
                    currentPropFilters = {
                        date_range: document.getElementById('propDateRangeFilter').value,
                        type: document.getElementById('propTypeFilter').value
                    };
                    currentPropPage = 1;
                    loadTouristReport();
                });

                // Pagination
                document.getElementById('prevPage').addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        loadPropertyReport(currentPage);
                    }
                });

                document.getElementById('nextPage').addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        loadPropertyReport(currentPage);
                    }
                });

                document.getElementById('propPrevPage').addEventListener('click', () => {
                    if (currentPropPage > 1) {
                        currentPropPage--;
                        loadTouristReport(currentPropPage);
                    }
                });

                document.getElementById('propNextPage').addEventListener('click', () => {
                    if (currentPropPage < propTotalPages) {
                        currentPropPage++;
                        loadTouristReport(currentPropPage);
                    }
                });

                // Rows per page
                document.getElementById('rowsPerPage').addEventListener('change', (e) => {
                    rowsPerPage = parseInt(e.target.value);
                    currentPage = 1;
                    loadPropertyReport();
                });

                document.getElementById('propRowsPerPage').addEventListener('change', (e) => {
                    propRowsPerPage = parseInt(e.target.value);
                    currentPropPage = 1;
                    loadTouristReport();
                });

                // Export
                exportBtn.addEventListener('click', () => {
                    const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                    const endpoint = activeTab === 'property-report'
                        ? '/api/reports/export-property'
                        : '/api/reports/export-tourist';

                    window.open(endpoint, '_blank');
                });

                // Upload
                uploadBtn.addEventListener('click', () => {
                    uploadModal.show();
                });

                // Add Report
                addReportBtn.addEventListener('click', function() {
                    const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                    if (activeTab === 'property-report') {
                        // Property Report tab -> open Property Report modal
                        document.getElementById('propertyReportForm').reset();
                        propertyReportModal.show();
                    } else {
                        // Tourist Report tab -> open Tourist Report modal
                        document.getElementById('touristReportForm').reset();
                        document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
                        touristReportModal.show();
                    }
                });

                submitUpload.addEventListener('click', function() {
                    const formData = new FormData(uploadForm);
                    const reportType = document.getElementById('reportType').value;

                    if (!reportType) {
                        showError('Please select a report type');
                        return;
                    }

                    fetch('/api/reports/upload', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess(data.message || 'Report uploaded successfully');
                            uploadModal.hide();
                            uploadForm.reset();

                            // Reload the appropriate report
                            if (reportType === 'property') {
                                loadPropertyReport();
                            } else {
                                loadTouristReport();
                            }
                        } else {
                            showError(data.message || 'Failed to upload report');
                        }
                    })
                    .catch(error => showError('Error uploading report: ' + error));
                });

                // Submit Property Report
                submitPropertyReport.addEventListener('click', function() {
                    const submitBtn = document.getElementById('submitPropertyReport');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';

                    const data = {
                        property_id: document.getElementById('propertySelect').value,
                        dot_accredited: document.getElementById('dotAccredited').value === 'true',
                        dot_valid: document.getElementById('dotValidUntil').value,
                        ptcao_registered: document.getElementById('ptcaoRegistered').value === 'true',
                        ptcao_valid: document.getElementById('ptcaoValidUntil').value,
                        classification: document.getElementById('classification').value,
                        male_employees: parseInt(document.getElementById('maleEmployees').value) || 0,
                        female_employees: parseInt(document.getElementById('femaleEmployees').value) || 0,
                        total_rooms: parseInt(document.getElementById('totalRooms').value) || 0,
                        daytour_capacity: parseInt(document.getElementById('daytourCapacity').value) || 0,
                        overnight_capacity: parseInt(document.getElementById('overnightCapacity').value) || 0
                    };

                    if (!data.property_id) {
                        showError('Please select a property');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit Report';
                        return;
                    }

                    apiFetch('/mto/api/reports/update-property', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    })

                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(err => { throw err; });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showSuccess('Property report submitted successfully');
                            propertyReportModal.hide();
                            loadPropertyReport();
                        } else {
                            showError(data.message || 'Failed to submit property report');
                        }
                    })
                    .catch(error => showError('Error submitting property report: ' + error))
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit Report';
                    });
                });

                // Submit Tourist Report
                submitTouristReport.addEventListener('click', function() {
                    const submitBtn = document.getElementById('submitTouristReport');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...';

                    const data = {
                        property_id: document.getElementById('touristPropertySelect').value,
                        report_date: document.getElementById('reportDate').value,
                        day_tour_guests: parseInt(document.getElementById('dayTourGuests').value) || 0,
                        overnight_guests: parseInt(document.getElementById('overnightGuests').value) || 0,
                        rooms_occupied: parseInt(document.getElementById('roomsOccupied').value) || 0,
                        foreign_daytour: parseInt(document.getElementById('foreignDaytour').value) || 0,
                        foreign_overnight: parseInt(document.getElementById('foreignOvernight').value) || 0,
                        male_tourists: parseInt(document.getElementById('maleTourists').value) || 0,
                        female_tourists: parseInt(document.getElementById('femaleTourists').value) || 0
                    };

                    // Validate inputs
                    if (!data.property_id) {
                        showError('Please select a property');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit Report';
                        return;
                    }

                    if (!data.report_date) {
                        showError('Please select a report date');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit Report';
                        return;
                    }
                    fetch('/mto/api/reports/add-tourist', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('jwt_token')}`
                        },
                        body: JSON.stringify(data)
                    })

                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text) });
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showSuccess('Tourist report submitted successfully');
                            touristReportModal.hide();
                            document.getElementById('touristReportForm').reset();
                            loadTouristReport();
                        } else {
                            showError(data.message || 'Failed to submit tourist report');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showError(error.message || 'Error submitting tourist report');
                    })
                    .finally(() => {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit Report';
                    });
                });
            }

            function showSuccess(message) {
                const toast = document.getElementById('successToast');
                toast.querySelector('.toast-body').textContent = message;
                bootstrap.Toast.getOrCreateInstance(toast).show();
            }

            function showError(message) {
                const toast = document.getElementById('errorToast');
                toast.querySelector('.toast-body').textContent = message;
                bootstrap.Toast.getOrCreateInstance(toast).show();
            }
        });

        function apiFetch(url, options = {}) {
            // Ensure headers exist
            options.headers = options.headers || {};
            // Add JWT token
            options.headers['Authorization'] = `Bearer ${localStorage.getItem('jwt_token')}`;
            // Set content type if body exists
            if (options.body && !options.headers['Content-Type']) {
                options.headers['Content-Type'] = 'application/json';
            }

            return fetch(url, options)
                .then(async response => {
                    const contentType = response.headers.get('content-type');
                    const isJson = contentType && contentType.includes('application/json');

                    if (!response.ok) {
                        // Try to parse error as JSON first
                        const error = isJson
                            ? await response.json()
                            : { message: await response.text() };
                        throw error;
                    }

                    return isJson ? response.json() : response.text();
                });
        }
    </script>
</body>
</html>